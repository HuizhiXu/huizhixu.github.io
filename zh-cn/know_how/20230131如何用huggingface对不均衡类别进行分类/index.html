<!DOCTYPE html>
<html lang="zh-cn"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">2023-01-31 如何用HuggingFace对不均衡类别进行分类 | 徐慧志的个人博客</title>
<meta property="og:title" content="2023-01-31 如何用HuggingFace对不均衡类别进行分类 | 徐慧志的个人博客" />
<meta name="twitter:title" content="2023-01-31 如何用HuggingFace对不均衡类别进行分类 | 徐慧志的个人博客" />
<meta itemprop="name" content="2023-01-31 如何用HuggingFace对不均衡类别进行分类 | 徐慧志的个人博客" />
<meta name="application-name" content="2023-01-31 如何用HuggingFace对不均衡类别进行分类 | 徐慧志的个人博客" />
<meta property="og:site_name" content="" />

<meta name="description" content="如果用Trainer这个API，只要更新compute_loss方法就可以，如果是用pytorch写的训练代码或者用了huggingface accelerate模型，那么要更新自己模型的forward函数。">
<meta itemprop="description" content="如果用Trainer这个API，只要更新compute_loss方法就可以，如果是用pytorch写的训练代码或者用了huggingface accelerate模型，那么要更新自己模型的forward函数。" />
<meta property="og:description" content="如果用Trainer这个API，只要更新compute_loss方法就可以，如果是用pytorch写的训练代码或者用了huggingface accelerate模型，那么要更新自己模型的forward函数。" />
<meta name="twitter:description" content="如果用Trainer这个API，只要更新compute_loss方法就可以，如果是用pytorch写的训练代码或者用了huggingface accelerate模型，那么要更新自己模型的forward函数。" />

<meta property="og:locale" content="zh-cn" />
<meta name="language" content="zh-cn" />

  <link rel="alternate" hreflang="zh-cn" href="http://localhost:1313/zh-cn/know_how/20230131%E5%A6%82%E4%BD%95%E7%94%A8huggingface%E5%AF%B9%E4%B8%8D%E5%9D%87%E8%A1%A1%E7%B1%BB%E5%88%AB%E8%BF%9B%E8%A1%8C%E5%88%86%E7%B1%BB/" title="中文 (简体)" />






<meta name="generator" content="Hugo 0.135.0">

    
    <meta property="og:url" content="http://localhost:1313/zh-cn/know_how/20230131%E5%A6%82%E4%BD%95%E7%94%A8huggingface%E5%AF%B9%E4%B8%8D%E5%9D%87%E8%A1%A1%E7%B1%BB%E5%88%AB%E8%BF%9B%E8%A1%8C%E5%88%86%E7%B1%BB/">
  <meta property="og:site_name" content="徐慧志的个人博客">
  <meta property="og:title" content="2023-01-31 如何用HuggingFace对不均衡类别进行分类">
  <meta property="og:description" content="如果用Trainer这个API，只要更新compute_loss方法就可以，如果是用pytorch写的训练代码或者用了huggingface accelerate模型，那么要更新自己模型的forward函数。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="know_how">
    <meta property="article:published_time" content="2023-01-31T19:31:50+08:00">
    <meta property="article:modified_time" content="2023-03-30T00:00:00+00:00">
    <meta property="article:tag" content="Tech">


    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="2023-01-31 如何用HuggingFace对不均衡类别进行分类">
  <meta name="twitter:description" content="如果用Trainer这个API，只要更新compute_loss方法就可以，如果是用pytorch写的训练代码或者用了huggingface accelerate模型，那么要更新自己模型的forward函数。">


    

    <link rel="canonical" href="http://localhost:1313/zh-cn/know_how/20230131%E5%A6%82%E4%BD%95%E7%94%A8huggingface%E5%AF%B9%E4%B8%8D%E5%9D%87%E8%A1%A1%E7%B1%BB%E5%88%AB%E8%BF%9B%E8%A1%8C%E5%88%86%E7%B1%BB/">
    <link href="../../../style.min.e390ba7da26222f4dc42a349955d76dbbe44e5ce2535a43de5a70633a0a9ec3c.css" rel="stylesheet">
    <link href="../../../code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="../../../icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../icons/favicon-16x16.png">
    <link rel="mask-icon" href="../../../icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="../../../favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">
    <meta name="color-scheme" content="light dark">

    
    <link rel="icon" type="image/svg+xml" href="../../../icons/favicon.svg">

    
    
</head>
<body data-theme = "" class="notransition">

<script src="../../../js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/zh-cn/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>首页</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="../../../know_how/">
                        技术
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="../../../life/">
                        生活见闻
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="../../../page/about/">
                        关于
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="../../../link/">
                        宝藏集结
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="../../../tags/">
                        分类
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">2023-01-31 如何用HuggingFace对不均衡类别进行分类</h1>
                
                
                
                <div class="post-meta">
                    <time datetime="2023-01-31T19:31:50&#43;08:00" itemprop="datePublished"> Jan 31, 2023 </time>
                </div>
                
            </header>
            
    
    <details class="toc" ZgotmplZ>
        <summary><b>目录</b></summary>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#数据均衡">数据均衡</a></li>
    <li><a href="#数据不均衡">数据不均衡</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
    </details>
            <div class="page-content">
                <h2 id="数据均衡">数据均衡</h2>
<p>做文本分类时，如果类别数量差别不大，可以用hugging face的Trainer类，训练代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#ff79c6">=</span> BertForSequenceClassification<span style="color:#ff79c6">.</span>from_pretrained(<span style="color:#f1fa8c">&#34;bert-base-chinese&#34;</span>, num_labels<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">len</span>(labels),
</span></span><span style="display:flex;"><span>                                                      problem_type<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;multi_label_classification&#34;</span>, id2label<span style="color:#ff79c6">=</span>id2label,
</span></span><span style="display:flex;"><span>                                                      label2id<span style="color:#ff79c6">=</span>label2id)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tokenizer <span style="color:#ff79c6">=</span> BertTokenizerFast<span style="color:#ff79c6">.</span>from_pretrained(<span style="color:#f1fa8c">&#34;bert-base-chinese&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">compute_metrics</span>(p):
</span></span><span style="display:flex;"><span>    preds <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">.</span>predictions[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">isinstance</span>(p<span style="color:#ff79c6">.</span>predictions,
</span></span><span style="display:flex;"><span>                                           <span style="color:#8be9fd;font-style:italic">tuple</span>) <span style="color:#ff79c6">else</span> p<span style="color:#ff79c6">.</span>predictions
</span></span><span style="display:flex;"><span>    result <span style="color:#ff79c6">=</span> multi_label_metrics(
</span></span><span style="display:flex;"><span>        predictions<span style="color:#ff79c6">=</span>preds,
</span></span><span style="display:flex;"><span>        labels<span style="color:#ff79c6">=</span>p<span style="color:#ff79c6">.</span>label_ids)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>training_args <span style="color:#ff79c6">=</span> TrainingArguments(
</span></span><span style="display:flex;"><span>    output_dir<span style="color:#ff79c6">=</span>model_directory, 
</span></span><span style="display:flex;"><span>    learning_rate<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5e-5</span>,
</span></span><span style="display:flex;"><span>    per_device_train_batch_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>,
</span></span><span style="display:flex;"><span>    per_device_eval_batch_size<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>,
</span></span><span style="display:flex;"><span>    num_train_epochs<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span>,
</span></span><span style="display:flex;"><span>    dataloader_drop_last<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>    weight_decay<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.01</span>,
</span></span><span style="display:flex;"><span>    save_steps<span style="color:#ff79c6">=</span><span style="color:#bd93f9">50</span>,
</span></span><span style="display:flex;"><span>    logging_steps<span style="color:#ff79c6">=</span><span style="color:#bd93f9">50</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>trainer <span style="color:#ff79c6">=</span> Trainer(
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">=</span>model,
</span></span><span style="display:flex;"><span>    args<span style="color:#ff79c6">=</span>training_args,
</span></span><span style="display:flex;"><span>    train_dataset<span style="color:#ff79c6">=</span>data[<span style="color:#f1fa8c">&#34;train&#34;</span>],
</span></span><span style="display:flex;"><span>    eval_dataset<span style="color:#ff79c6">=</span>data[<span style="color:#f1fa8c">&#34;train&#34;</span>],
</span></span><span style="display:flex;"><span>    tokenizer<span style="color:#ff79c6">=</span>tokenizer,
</span></span><span style="display:flex;"><span>    compute_metrics<span style="color:#ff79c6">=</span>compute_metrics
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>trainer<span style="color:#ff79c6">.</span>train()
</span></span><span style="display:flex;"><span>trainer<span style="color:#ff79c6">.</span>evaluate()
</span></span></code></pre></div><p>model_directory 是模型存储路径，data是数据。</p>
<h2 id="数据不均衡">数据不均衡</h2>
<p>如果类别数据不均衡时，例如 class A有1000个数据，class B有100个数据，也可以用上面的训练代码，但是预测B的效果不会很好。</p>
<p>要解决数据不均衡的问题，可以考虑加一个class weight。加class weight的意思是给class B一个更高的权重，让模型预测的时候多考虑一下class B，方向往class B偏离。</p>
<p>官网给了一个例子，需要我们继承Trainer类，自定义一个类，也就是这里的CustomTrainer，重写compute_loss 这个方法。</p>
<p>在训练的时候只要初始化CustomTrainer类就可以了，也就是把trainer = Trainer(…) 改为trainer = CustomTrainer(…)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> torch <span style="color:#ff79c6">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> transformers <span style="color:#ff79c6">import</span> Trainer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">CustomTrainer</span>(Trainer):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">compute_loss</span>(self, model, inputs, return_outputs<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>):
</span></span><span style="display:flex;"><span>        labels <span style="color:#ff79c6">=</span> inputs<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;labels&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># forward pass</span>
</span></span><span style="display:flex;"><span>        outputs <span style="color:#ff79c6">=</span> model(<span style="color:#ff79c6">**</span>inputs)
</span></span><span style="display:flex;"><span>        logits <span style="color:#ff79c6">=</span> outputs<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;logits&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># compute custom loss</span>
</span></span><span style="display:flex;"><span>        loss_fct <span style="color:#ff79c6">=</span> nn<span style="color:#ff79c6">.</span>CrossEntropyLoss(weight<span style="color:#ff79c6">=</span>torch<span style="color:#ff79c6">.</span>tensor([<span style="color:#bd93f9">0.2</span>, <span style="color:#bd93f9">0.3</span>]))
</span></span><span style="display:flex;"><span>        loss <span style="color:#ff79c6">=</span> loss_fct(logits<span style="color:#ff79c6">.</span>view(<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>, self<span style="color:#ff79c6">.</span>model<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>num_labels), labels<span style="color:#ff79c6">.</span>view(<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> (loss, outputs) <span style="color:#ff79c6">if</span> return_outputs <span style="color:#ff79c6">else</span> loss
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">...</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>trainer <span style="color:#ff79c6">=</span> CustomTrainer(
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">=</span>model,
</span></span><span style="display:flex;"><span>    args<span style="color:#ff79c6">=</span>training_args,
</span></span><span style="display:flex;"><span>    train_dataset<span style="color:#ff79c6">=</span>encoded_data[<span style="color:#f1fa8c">&#34;train&#34;</span>],
</span></span><span style="display:flex;"><span>    eval_dataset<span style="color:#ff79c6">=</span>encoded_data[<span style="color:#f1fa8c">&#34;train&#34;</span>],
</span></span><span style="display:flex;"><span>    tokenizer<span style="color:#ff79c6">=</span>tokenizer,
</span></span><span style="display:flex;"><span>    compute_metrics<span style="color:#ff79c6">=</span>compute_metrics
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>trainer<span style="color:#ff79c6">.</span>train()
</span></span><span style="display:flex;"><span>trainer<span style="color:#ff79c6">.</span>evaluate()
</span></span></code></pre></div><p>直接复制可能会出错。 如果出现了如下错误提示，显示loss_fct和loss错误。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ValueError: Expected <span style="color:#8be9fd;font-style:italic">input</span> batch_size (<span style="color:#bd93f9">2</span>) to <span style="color:#ff79c6">match</span> target batch_size (<span style="color:#bd93f9">20</span>)<span style="color:#ff79c6">.</span>
</span></span></code></pre></div><p>所以要改loss_fct，去看看源代码是如何计算loss的。<a href="https://github.com/huggingface/transformers/blob/v4.17.0/src/transformers/models/bert/modeling_bert.py#L1563-L1583">源代码</a> 进行loss的计算是在BertForSequenceClassification的forward方法里面。回归、二分类和多分类都有不同的loss 计算方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># 源代码 L1563-L1583</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> labels 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">is</span> <span style="color:#ff79c6">not</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> self<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>problem_type <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> self<span style="color:#ff79c6">.</span>num_labels <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>:
</span></span><span style="display:flex;"><span>                    self<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>problem_type <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;regression&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">elif</span> self<span style="color:#ff79c6">.</span>num_labels <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">and</span> (labels<span style="color:#ff79c6">.</span>dtype <span style="color:#ff79c6">==</span> torch<span style="color:#ff79c6">.</span>long <span style="color:#ff79c6">or</span> labels<span style="color:#ff79c6">.</span>dtype <span style="color:#ff79c6">==</span> torch<span style="color:#ff79c6">.</span>int):
</span></span><span style="display:flex;"><span>                    self<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>problem_type <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;single_label_classification&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                    self<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>problem_type <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;multi_label_classification&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> self<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>problem_type <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;regression&#34;</span>:
</span></span><span style="display:flex;"><span>                loss_fct <span style="color:#ff79c6">=</span> MSELoss()
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> self<span style="color:#ff79c6">.</span>num_labels <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>:
</span></span><span style="display:flex;"><span>                    loss <span style="color:#ff79c6">=</span> loss_fct(logits<span style="color:#ff79c6">.</span>squeeze(), labels<span style="color:#ff79c6">.</span>squeeze())
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                    loss <span style="color:#ff79c6">=</span> loss_fct(logits, labels)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">elif</span> self<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>problem_type <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;single_label_classification&#34;</span>:
</span></span><span style="display:flex;"><span>                loss_fct <span style="color:#ff79c6">=</span> CrossEntropyLoss()
</span></span><span style="display:flex;"><span>                loss <span style="color:#ff79c6">=</span> loss_fct(logits<span style="color:#ff79c6">.</span>view(<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>, self<span style="color:#ff79c6">.</span>num_labels), labels<span style="color:#ff79c6">.</span>view(<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">elif</span> self<span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">.</span>problem_type <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;multi_label_classification&#34;</span>:
</span></span><span style="display:flex;"><span>                loss_fct <span style="color:#ff79c6">=</span> BCEWithLogitsLoss()
</span></span><span style="display:flex;"><span>                loss <span style="color:#ff79c6">=</span> loss_fct(logits, labels)
</span></span></code></pre></div><p>所以如果出现batch_size和target_size 不匹配的问题， 要考虑我们解决的问题是二分类还是多分类的问题，多分类用BCE，代码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">CustomTrainer</span>(Trainer):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">compute_loss</span>(self, model, inputs, return_outputs<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>):
</span></span><span style="display:flex;"><span>        labels <span style="color:#ff79c6">=</span> inputs<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;labels&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># forward pass</span>
</span></span><span style="display:flex;"><span>        outputs <span style="color:#ff79c6">=</span> model(<span style="color:#ff79c6">**</span>inputs)
</span></span><span style="display:flex;"><span>        logits <span style="color:#ff79c6">=</span> outputs<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;logits&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># compute custom loss</span>
</span></span><span style="display:flex;"><span>        loss_fct <span style="color:#ff79c6">=</span> nn<span style="color:#ff79c6">.</span>BCEWithLogitsLoss(
</span></span><span style="display:flex;"><span>            weight<span style="color:#ff79c6">=</span>tensor([<span style="color:#bd93f9">0.9999</span>, <span style="color:#bd93f9">3.1111</span>,<span style="color:#bd93f9">0.9999</span>, <span style="color:#bd93f9">0.9999</span>, <span style="color:#bd93f9">0.9999</span>,<span style="color:#bd93f9">2.1333</span>]))
</span></span><span style="display:flex;"><span>        loss <span style="color:#ff79c6">=</span> loss_fct(logits, labels)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> (loss, outputs) <span style="color:#ff79c6">if</span> return_outputs <span style="color:#ff79c6">else</span> loss
</span></span></code></pre></div><p>loss_fct 里面的 weight 的计算可以用sklearn.utils.compute_weight这个方法计算。classes是数据的类别，不重复，y是所有数据的label。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>class_weights <span style="color:#ff79c6">=</span> class_weight<span style="color:#ff79c6">.</span>compute_class_weight(<span style="color:#f1fa8c">&#39;balanced&#39;</span>, classes<span style="color:#ff79c6">=</span>np<span style="color:#ff79c6">.</span>array(data<span style="color:#ff79c6">.</span>labels<span style="color:#ff79c6">.</span>unique()),
</span></span><span style="display:flex;"><span>                                                  y<span style="color:#ff79c6">=</span>np<span style="color:#ff79c6">.</span>array(data<span style="color:#ff79c6">.</span>labels))
</span></span><span style="display:flex;"><span>class_weights <span style="color:#ff79c6">=</span> torch<span style="color:#ff79c6">.</span>tensor(class_weights, dtype<span style="color:#ff79c6">=</span>torch<span style="color:#ff79c6">.</span>float)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(class_weights)
</span></span></code></pre></div><p>如果出现这个错误那，就说明模型训练的时候，有可能模型、输入或者loss在本地device，建议在模型和输入后面加.to(device)。
Hugging Face说Trainer类它自己会识别gpu环境，是不需要把模型和数据转到gpu的。那么最有可能就是loss的计算还在本地。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RuntimeError: Expected <span style="color:#8be9fd;font-style:italic">all</span> tensors to be on the same device, but found at least two devices, cuda:<span style="color:#bd93f9">0</span> <span style="color:#ff79c6">and</span> cpu!
</span></span></code></pre></div><p>最后的解决办法是，在计算loss的时候将loss传到device上面去。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>device <span style="color:#ff79c6">=</span> torch<span style="color:#ff79c6">.</span>device(<span style="color:#f1fa8c">&#34;cuda&#34;</span>) <span style="color:#ff79c6">if</span> torch<span style="color:#ff79c6">.</span>cuda<span style="color:#ff79c6">.</span>is_available() <span style="color:#ff79c6">else</span> torch<span style="color:#ff79c6">.</span>device(<span style="color:#f1fa8c">&#34;cpu&#34;</span>)
</span></span><span style="display:flex;"><span>loss_fct <span style="color:#ff79c6">=</span> nn<span style="color:#ff79c6">.</span>BCEWithLogitsLoss(
</span></span><span style="display:flex;"><span>            weight<span style="color:#ff79c6">=</span>tensor([<span style="color:#bd93f9">0.9529</span>, <span style="color:#bd93f9">0.9529</span>, <span style="color:#bd93f9">1.8027</span>, <span style="color:#bd93f9">0.9394</span>, <span style="color:#bd93f9">0.9529</span>, <span style="color:#bd93f9">0.9529</span>, <span style="color:#bd93f9">0.9529</span>, <span style="color:#bd93f9">0.9667</span>, <span style="color:#bd93f9">0.9529</span>,
</span></span><span style="display:flex;"><span>                           <span style="color:#bd93f9">0.9529</span>]))<span style="color:#ff79c6">.</span>to(device)
</span></span></code></pre></div><p>总结：如果用Trainer这个API，只要更新compute_loss方法就可以，如果是用pytorch写的训练代码或者用了huggingface accelerate模型，那么要更新自己模型的forward函数。</p>
<h2 id="参考">参考</h2>
<p><strong><a href="https://discuss.huggingface.co/t/how-can-i-use-class-weights-when-training/1067">How can I use class_weights when training?</a></strong></p>
<p><strong><a href="https://stackoverflow.com/questions/71581197/what-is-the-loss-function-used-in-trainer-from-the-transformers-library-of-huggi">What is the loss function used in Trainer from the Transformers library of Hugging Face?</a></strong></p>
<p><strong><a href="https://discuss.huggingface.co/t/custom-loss-function-forward-vs-custom-loss/21526">Custom loss function forward vs. custom_loss</a></strong></p>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
</div>
    <small class="footer_copyright">
        © 2025 .
        Powered by <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noopener">Hugo blog awesome</a>.
    </small>
</footer>







    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
